Ly9pbXBvcnQgIi4vZ3VpIgppbXBvcnQgUmVuZGVyTGliIGZyb20gJy4uL1JlbmRlckxpYi9pbmRleCc7CmltcG9ydCB7IGdldExvd2VyQ29udGFpbmVyLCBnZXRJdGVtSWQgfSBmcm9tICcuL3V0aWwnOwoKbGV0IG5vdFNpZ21hID0gZmFsc2U7Cgpjb25zdCBtYyA9IENsaWVudC5nZXRNaW5lY3JhZnQoKTsKY29uc3QgZm9zc2lscyA9IFsKICAgIGAwMDEwMAogICAgIDAxMDEwCiAgICAgMTAwMDEKICAgICAxMDAxMAogICAgIDEwMDAwLmAsCiAgICBgMDAxMTEwMAogICAgIDAxMDEwMTAKICAgICAxMDAxMDAxCiAgICAgMDAwMTAwMGAsCiAgICBgMDAwMTExMTAKICAgICAwMDEwMDAwMQogICAgIDExMDAwMDEwCiAgICAgMTEwMDAwMDAuYCwKICAgIGAwMDExMDAKICAgICAwMTExMTAKICAgICAxMTExMTFgLAogICAgYDAwMDAxMAogICAgIDAwMTExMQogICAgIDAxMDExMAogICAgIDEwMTAxMAogICAgIDAxMDEwMC5gLAogICAgYDAwMDExCiAgICAgMDExMDAKICAgICAxMTExMQogICAgIDAxMTAwCiAgICAgMDAwMTFgLAogICAgYDExMTEKICAgICAxMDAxCiAgICAgMTEwMQogICAgIDAwMDEKICAgICAxMTExLmAsCiAgICBgMDExMTEwCiAgICAgMTExMTExCiAgICAgMDExMTEwCiAgICAgMDAxMTAwYApdLm1hcChzID0+IHsKICAgIHMgPSBzLnRyaW0oKTsKICAgIGNvbnN0IGEgPSBzW3MubGVuZ3RoIC0gMV0gPT09ICcuJzsKICAgIGlmIChhKSBzID0gcy5zbGljZSgwLCAtMSk7CiAgICBjb25zdCBsID0gcy5zcGxpdCgnXG4nKS5tYXAodiA9PiB2LnRyaW0oKS5zcGxpdCgnJykubWFwKHYgPT4gdiA9PT0gJzEnID8gdHJ1ZSA6IGZhbHNlKSk7CiAgICByZXR1cm4gewogICAgICBhcnI6IGwsCiAgICAgIHc6IGxbMF0ubGVuZ3RoLAogICAgICBoOiBsLmxlbmd0aCwKICAgICAgc2l6ZTogbC5yZWR1Y2UoKGEsIHYpID0+IGEgKyB2LnJlZHVjZSgoYSwgdikgPT4gYSArIHYsIDApLCAwKSwKICAgICAgYQogICAgfTsKfSk7CgpsZXQgbGFzdEd1aU9wZW5lZDsKCnJlZ2lzdGVyKGBndWlPcGVuZWRgLCBldm4gPT4gewogICAgbGFzdEd1aU9wZW5lZCA9IGV2bi5ndWkKfSkKCmNvbnN0IHBhdGhUbyA9ICh4LCB5LCB6KSA9PiB7CiAgICBsZXQgbG9jYWxUb0Nvbm5lY3QgPSBbXTsKCiAgICBsZXQgZW5kUG9pbnQgPSBuZXcgUG9pbnQoeCwgeSwgeik7CgogICAgbGV0IHBhdGggPSBnZXRQYXRoRW50aXR5KGVuZFBvaW50LngsIGVuZFBvaW50LnksIGVuZFBvaW50LnopOwoKICAgIGlmKCFwYXRoKSByZXR1cm47CgogICAgZm9yKGkgPSAwOyBpIDwgcGF0aC5mdW5jXzc1ODc0X2QoKSAtIDE7IGkrKykgeyAvLyBnZXRDdXJyZW50UGF0aExlbmd0aAogICAgICAgIGxldCBjdXJyZW50UCA9IHBhdGguZnVuY183NTg3N19hKGkpOyAvLyBnZXRQYXRoUG9pbnRGcm9tSW5kZXgKICAgICAgICBsZXQgcG9pbnQgPSBuZXcgUG9pbnQoY3VycmVudFAuZmllbGRfNzU4MzlfYSArIDAuNSwgY3VycmVudFAuZmllbGRfNzU4MzdfYiArIDAuNSwgY3VycmVudFAuZmllbGRfNzU4MzhfYyArIDAuNSk7IC8vIHhDb29yZCB5Q29vcmQgekNvb3JkCiAgICAgICAgbG9jYWxUb0Nvbm5lY3QucHVzaChwb2ludCk7CiAgICB9CgogICAgcmV0dXJuIGxvY2FsVG9Db25uZWN0Owp9CgogIApleHBvcnQgZnVuY3Rpb24gZ2V0TmV4dFNsb3RUb0NsaWNrKGd1aSkgewogICAgaWYobm90U2lnbWEpIHJldHVybiBmYWxzZTsKICAgIGlmIChndWkuZ2V0Q2xhc3MoKS5nZXRTaW1wbGVOYW1lKCkgIT09ICdHdWlDaGVzdCcpIHsKICAgICAgICBDaGF0TGliLmNoYXQoYCR7cHJlZml4fUdVSSBDbGFzcyBJcyBOb3QgR3VpQ2hlc3RgKQogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIGNvbnN0IGludiA9IGdldExvd2VyQ29udGFpbmVyKGd1aSk7CiAgICBjb25zdCBuYW1lID0gaW52LmZ1bmNfNzAwMDVfY18oKTsKICAKICAgIGxldCBwb3NzID0gW107CiAgICBsZXQgc2l6ZSA9IDA7CiAgICBsZXQgZHVzdCA9IG5ldyBBcnJheSg1NCkuZmlsbChmYWxzZSk7CiAgICBsZXQgZGlydCA9IG5ldyBBcnJheSg1NCkuZmlsbChmYWxzZSk7CiAgICBsZXQgdHJlYSA9IG5ldyBBcnJheSg1NCkuZmlsbChmYWxzZSk7CiAgICBsZXQgZGMgPSAwOwogICAgbGV0IGNoYXJnZXMgPSAwOwogICAgbGV0IGhpc3QgPSBuZXcgQXJyYXkoNTQpLmZpbGwoMCk7CiAgCiAgICBjb25zdCB0ZXN0ID0gKGwsIGkpID0+IHsKICAgICAgY29uc3QgZiA9IGZvc3NpbHNbbC5mXTsKICAgICAgbGV0IHkgPSB+fihpIC8gOSkgLSB+fihsLnAgLyA5KTsKICAgICAgbGV0IHggPSAoaSAlIDkpIC0gKGwucCAlIDkpOwogICAgICBpZiAoeCA8IDAgfHwgeSA8IDApIHJldHVybiBmYWxzZTsKICAgICAgaWYgKGwuciAmIDEpIHsKICAgICAgICBjb25zdCB0ID0geTsKICAgICAgICB5ID0geDsKICAgICAgICB4ID0gdDsKICAgICAgfQogICAgICBpZiAoeCA+PSBmLncgfHwgeSA+PSBmLmgpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKGwubSBeIChsLnIgPT09IDEgfHwgbC5yID09PSAyKSkgeCA9IGYudyAtIHggLSAxOwogICAgICBpZiAobC5yID09PSAyIHx8IGwuciA9PT0gMykgeSA9IGYuaCAtIHkgLSAxOwogICAgICByZXR1cm4gZi5hcnJbeV1beF07CiAgICB9OwogIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1NDsgaSsrKSB7CiAgICAgIGxldCBpdGVtID0gaW52LmZ1bmNfNzAzMDFfYShpKTsKICAgICAgaWYgKGl0ZW0gPT09IG51bGwpIGNvbnRpbnVlOwogICAgICBpZiAoZ2V0SXRlbUlkKGl0ZW0pICE9PSAnbWluZWNyYWZ0OnN0YWluZWRfZ2xhc3NfcGFuZScpIGNvbnRpbnVlOwogICAgICBsZXQgZG1nID0gaXRlbS5mdW5jXzc3OTYwX2ooKTsKICAgICAgZHVzdFtpXSA9IGRtZyA9PT0gMDsKICAgICAgZGlydFtpXSA9IGRtZyAhPT0gMDsKICAgICAgdHJlYVtpXSA9IGRtZyA9PT0gNTsKICAgICAgaWYgKGR1c3RbaV0pIHsKICAgICAgICBkYysrOwogICAgICB9IGVsc2UgaWYgKGRpcnRbaV0gJiYgY2hhcmdlcyA9PT0gLTEpIHsKICAgICAgICBjb25zdCB0YWcgPSBpdGVtLmZ1bmNfNzc5NzhfcCgpLmZ1bmNfNzQ3NzVfbCgnZGlzcGxheScpOwogICAgICAgIGNvbnN0IGxvcmUgPSB0YWcuZnVuY18xNTAyOTVfYygnTG9yZScsIDgpOwogICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbG9yZS5mdW5jXzc0NzQ1X2MoKTsgaisrKSB7CiAgICAgICAgICBsZXQgbSA9IGxvcmUuZnVuY18xNTAzMDdfZihqKS5tYXRjaCgvXsKnN0NoaXNlbCBDaGFyZ2VzIFJlbWFpbmluZzogwqcuKFxkKykkLyk7CiAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICBjaGFyZ2VzID0gK21bMV07CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIAogICAgaWYgKGRjID4gMCAmJiBzaXplID09PSAwKSB7CiAgICAgIGNvbnN0IHRhZyA9IGludi5mdW5jXzcwMzAxX2EoZHVzdC5pbmRleE9mKHRydWUpKS5mdW5jXzc3OTc4X3AoKS5mdW5jXzc0Nzc1X2woJ2Rpc3BsYXknKTsKICAgICAgY29uc3QgbG9yZSA9IHRhZy5mdW5jXzE1MDI5NV9jKCdMb3JlJywgOCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbG9yZS5mdW5jXzc0NzQ1X2MoKTsgaSsrKSB7CiAgICAgICAgbGV0IG0gPSBsb3JlLmZ1bmNfMTUwMzA3X2YoaSkubWF0Y2goL17CpzdGb3NzaWwgRXhjYXZhdGlvbiBQcm9ncmVzczogwqcuKFtcZC5dKyklJC8pOwogICAgICAgIGlmIChtKSB7CiAgICAgICAgICBzaXplID0gTWF0aC5yb3VuZCgxMDAgLyAoK21bMV0pICogZGMpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgCiAgICBmb3NzaWxzLmZvckVhY2goKHYsIGkpID0+IHsKICAgICAgaWYgKHNpemUgPiAwICYmIHYuc2l6ZSAhPT0gc2l6ZSkgcmV0dXJuOwogICAgICBmb3IgKGxldCB5ID0gMDsgeSA8PSA2IC0gdi5oOyB5KyspIHsKICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8PSA5IC0gdi53OyB4KyspIHsKICAgICAgICAgIHBvc3MucHVzaCh7IGY6IGksIHA6ICh5ICogOSkgKyB4LCByOiAwLCBtOiBmYWxzZSB9KTsKICAgICAgICAgIHBvc3MucHVzaCh7IGY6IGksIHA6ICh5ICogOSkgKyB4LCByOiAyLCBtOiBmYWxzZSB9KTsKICAgICAgICAgIGlmICh2LmEpIHsKICAgICAgICAgICAgcG9zcy5wdXNoKHsgZjogaSwgcDogKHkgKiA5KSArIHgsIHI6IDAsIG06IHRydWUgfSk7CiAgICAgICAgICAgIHBvc3MucHVzaCh7IGY6IGksIHA6ICh5ICogOSkgKyB4LCByOiAyLCBtOiB0cnVlIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKGxldCB5ID0gMDsgeSA8PSA2IC0gdi53OyB5KyspIHsKICAgICAgICBmb3IgKGxldCB4ID0gMDsgeCA8PSA5IC0gdi5oOyB4KyspIHsKICAgICAgICAgIHBvc3MucHVzaCh7IGY6IGksIHA6ICh5ICogOSkgKyB4LCByOiAxLCBtOiBmYWxzZSB9KTsKICAgICAgICAgIHBvc3MucHVzaCh7IGY6IGksIHA6ICh5ICogOSkgKyB4LCByOiAzLCBtOiBmYWxzZSB9KTsKICAgICAgICAgIGlmICh2LmEpIHsKICAgICAgICAgICAgcG9zcy5wdXNoKHsgZjogaSwgcDogKHkgKiA5KSArIHgsIHI6IDEsIG06IHRydWUgfSk7CiAgICAgICAgICAgIHBvc3MucHVzaCh7IGY6IGksIHA6ICh5ICogOSkgKyB4LCByOiAzLCBtOiB0cnVlIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgCiAgICBwb3NzID0gcG9zcy5maWx0ZXIodiA9PiB7CiAgICAgIGlmIChzaXplID4gMCAmJiBmb3NzaWxzW3YuZl0uc2l6ZSAhPT0gc2l6ZSkgcmV0dXJuIGZhbHNlOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDU0OyBpKyspIHsKICAgICAgICBpZiAoKCFkaXJ0W2ldKSAmJiAodGVzdCh2LCBpKSBeIGR1c3RbaV0pKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICAKICAgIGludi5mdW5jXzExMDEzM19hKGAke3Bvc3MubGVuZ3RofSBPcmllbnRhdGlvbnMgfCAke2NoYXJnZXN9IENoYXJnZXNgKTsKICAgIGlmIChwb3NzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gLTE7IH0KICAKICAgIGhpc3QgPSBuZXcgQXJyYXkoNTQpLmZpbGwoMCk7CiAgICBwb3NzLmZvckVhY2godiA9PiB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTQ7IGkrKykgewogICAgICAgIGlmICghZGlydFtpXSkgY29udGludWU7CiAgICAgICAgaWYgKHRlc3QodiwgaSkpIGhpc3RbaV0rKzsKICAgICAgfQogICAgfSk7CiAgCiAgICBsZXQgYmVzdCA9IGhpc3QucmVkdWNlKChhLCB2LCBpKSA9PiBoaXN0W2FdID4gdiA/IGEgOiBpLCAwKTsKICAKICAgIHJldHVybiBiZXN0Owp9Cgpjb25zdCBmb3J3YXJkQmluZCA9IG5ldyBLZXlCaW5kKG1jLmZpZWxkXzcxNDc0X3kuZmllbGRfNzQzNTFfdyk7CmNvbnN0IGJhY2t3YXJkQmluZCA9IG5ldyBLZXlCaW5kKG1jLmZpZWxkXzcxNDc0X3kuZmllbGRfNzQzNjhfeSk7CmNvbnN0IGxlZnRCaW5kID0gbmV3IEtleUJpbmQobWMuZmllbGRfNzE0NzRfeS5maWVsZF83NDM3MF94KTsKY29uc3QgcmlnaHRCaW5kID0gbmV3IEtleUJpbmQobWMuZmllbGRfNzE0NzRfeS5maWVsZF83NDM2Nl96KTsKY29uc3QganVtcEJpbmQgPSBuZXcgS2V5QmluZChtYy5maWVsZF83MTQ3NF95LmZpZWxkXzc0MzE0X0EpOwpjb25zdCBzbmVha0JpbmQgPSBuZXcgS2V5QmluZChtYy5maWVsZF83MTQ3NF95LmZpZWxkXzc0MzExX0UpOwpjb25zdCBzcHJpbnRCaW5kID0gbmV3IEtleUJpbmQobWMuZmllbGRfNzE0NzRfeS5maWVsZF8xNTE0NDRfVik7CmNvbnN0IGF0dGFja0JpbmQgPSBuZXcgS2V5QmluZChtYy5maWVsZF83MTQ3NF95LmZpZWxkXzc0MzEyX0YpOwpjb25zdCB1c2VCaW5kID0gbmV3IEtleUJpbmQobWMuZmllbGRfNzE0NzRfeS5maWVsZF83NDMxM19HKTsKICAKY2xhc3MgUG9pbnQgewogICAgY29uc3RydWN0b3IoeCwgeSwgeikgewogICAgICAgIHRoaXMueCA9IHg7CiAgICAgICAgdGhpcy55ID0geTsKICAgICAgICB0aGlzLnogPSB6OwogICAgfQp9CgpsZXQgY3VycmVudFVzZXJQYXRoID0gW107CgpsZXQgYXV0b1dhbGsgPSBmYWxzZTsKbGV0IHJvdG1vZGUgPSB0cnVlOwoKY29uc3Qgc3RvcEFsbE1vdmVtZW50ID0gKCkgPT4gewogICAganVtcEJpbmQuc2V0U3RhdGUoZmFsc2UpOwogICAgZm9yd2FyZEJpbmQuc2V0U3RhdGUoZmFsc2UpOwogICAgcmlnaHRCaW5kLnNldFN0YXRlKGZhbHNlKTsKICAgIGJhY2t3YXJkQmluZC5zZXRTdGF0ZShmYWxzZSk7CiAgICBsZWZ0QmluZC5zZXRTdGF0ZShmYWxzZSk7CiAgICBzbmVha0JpbmQuc2V0U3RhdGUoZmFsc2UpCn0KCmNvbnN0IGdldFBhdGhFbnRpdHkgPSAoeCwgeSwgeikgPT4gewogICAgbm9kZVByb2Nlc3NvciA9IG5ldyBuZXQubWluZWNyYWZ0LndvcmxkLnBhdGhmaW5kZXIuV2Fsa05vZGVQcm9jZXNzb3IoKTsKICAgIG5vZGVQcm9jZXNzb3IuZnVuY18xNzYxNzVfYSh0cnVlKTsgLy8gc2V0RW50ZXJEb29ycwogICAgbm9kZVByb2Nlc3Nvci5mdW5jXzE3NjE3Nl9jKHRydWUpOyAvLyBzZXRBdm9pZHNXYXRlcgogICAgcGF0aEZpbmRlciA9IG5ldyBuZXQubWluZWNyYWZ0LnBhdGhmaW5kaW5nLlBhdGhGaW5kZXIobm9kZVByb2Nlc3Nvcik7CiAgICByZXR1cm4gcGF0aEZpbmRlci5mdW5jXzE4MDc4Ml9hKAogICAgCVdvcmxkLmdldFdvcmxkKCksCiAgICAJUGxheWVyLmdldFBsYXllcigpLAogICAgCW5ldyBuZXQubWluZWNyYWZ0LnV0aWwuQmxvY2tQb3MoeCwgeSwgeiksCiAgICAJMjAwMAogICAgKTsgLy8gY3JlYXRlRW50aXR5UGF0aFRvCn07CgoKY29uc3QgcG9zc2libGVSb3RhdGlvbnMgPSBbLTE4MCwgLTEzNSwgLTkwLCAtNDUsIDAsIDQ1LCA5MCwgMTM1LCAxODBdOwoKY29uc3QgZ2V0Q2xvc2VzdCA9IChjb3VudHMsIGdvYWwpID0+IHsKICAgIHJldHVybiBjb3VudHMucmVkdWNlKChwcmV2LCBjdXJyKSA9PiBNYXRoLmFicyhjdXJyIC0gZ29hbCkgPCBNYXRoLmFicyhwcmV2IC0gZ29hbCkgPyBjdXJyIDogcHJldik7Cn0KCmNvbnN0IHByZXNzS2V5cyA9IChhcnIpID0+IHsKICAgIGFyci5mb3JFYWNoKGtleSA9PiB7CiAgICAgICAgc3dpdGNoKGtleSkgewogICAgICAgICAgICBjYXNlIGBXYDoKICAgICAgICAgICAgICAgIGZvcndhcmRCaW5kLnNldFN0YXRlKHRydWUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgYFNgOgogICAgICAgICAgICAgICAgYmFja3dhcmRCaW5kLnNldFN0YXRlKHRydWUpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgYEFgOgogICAgICAgICAgICAgICAgbGVmdEJpbmQuc2V0U3RhdGUodHJ1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBgRGA6CiAgICAgICAgICAgICAgICByaWdodEJpbmQuc2V0U3RhdGUodHJ1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBgU1BBQ0VgOgogICAgICAgICAgICAgICAgLy9qdW1wQmluZC5zZXRTdGF0ZSh0cnVlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIGBTTkVBS2A6CiAgICAgICAgICAgICAgICBzbmVha0JpbmQuc2V0U3RhdGUodHJ1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBgU1BSSU5UYDoKICAgICAgICAgICAgICAgIHNwcmludEJpbmQuc2V0U3RhdGUodHJ1ZSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBgTEVGVENgOgogICAgICAgICAgICAgICAgYXR0YWNrQmluZC5zZXRTdGF0ZSh0cnVlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIGBSSUdIVENgOgogICAgICAgICAgICAgICAgdXNlQmluZC5zZXRTdGF0ZSh0cnVlKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0pOwp9Cgpjb25zdCBnZXRCaW5kID0gKGRpciwgcG4sIHlhdykgPT4gewogICAgeWF3ID0gZ2V0Q2xvc2VzdChwb3NzaWJsZVJvdGF0aW9ucywgeWF3KTsKICAgIHN3aXRjaCh5YXcpIHsKICAgICAgICBjYXNlIDE4MDoKICAgICAgICBjYXNlIC0xODA6CiAgICAgICAgICAgIHBuID09PSBgUGAgPyBkaXIgPT09IGBYYCA/IHByZXNzS2V5cyhbYERgXSkgOiBwcmVzc0tleXMoW2BTYF0pIDogZGlyID09PSBgWGAgPyBwcmVzc0tleXMoW2BBYF0pIDogcHJlc3NLZXlzKFtgV2BdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAtOTA6CiAgICAgICAgICAgIHBuID09PSBgUGAgPyBkaXIgPT09IGBYYCA/IHByZXNzS2V5cyhbYFdgXSkgOiBwcmVzc0tleXMoW2BEYF0pIDogZGlyID09PSBgWGAgPyBwcmVzc0tleXMoW2BTYF0pIDogcHJlc3NLZXlzKFtgQWBdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAwOgogICAgICAgICAgICBwbiA9PT0gYFBgID8gZGlyID09PSBgWGAgPyBwcmVzc0tleXMoW2BBYF0pIDogcHJlc3NLZXlzKFtgV2BdKSA6IGRpciA9PT0gYFhgID8gcHJlc3NLZXlzKFtgRGBdKSA6IHByZXNzS2V5cyhbYFNgXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgOTA6CiAgICAgICAgICAgIHBuID09PSBgUGAgPyBkaXIgPT09IGBYYCA/IHByZXNzS2V5cyhbYFNgXSkgOiBwcmVzc0tleXMoW2BBYF0pIDogZGlyID09PSBgWGAgPyBwcmVzc0tleXMoW2BXYF0pIDogcHJlc3NLZXlzKFtgRGBdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAtMTM1OgogICAgICAgICAgICBwbiA9PT0gYFBgID8gZGlyID09PSBgWGAgPyBwcmVzc0tleXMoW2BXYCwgYERgXSkgOiBwcmVzc0tleXMoW2BTYCwgYERgXSkgOiBkaXIgPT09IGBYYCA/IHByZXNzS2V5cyhbYFNgLCBgQWBdKSA6IHByZXNzS2V5cyhbYFdgLCBgQWBdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAxMzU6CiAgICAgICAgICAgIHBuID09PSBgUGAgPyBkaXIgPT09IGBYYCA/IHByZXNzS2V5cyhbYFNgLCBgRGBdKSA6IHByZXNzS2V5cyhbYFNgLCBgQWBdKSA6IGRpciA9PT0gYFhgID8gcHJlc3NLZXlzKFtgV2AsIGBBYF0pIDogcHJlc3NLZXlzKFtgV2AsIGBEYF0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIC00NToKICAgICAgICAgICAgcG4gPT09IGBQYCA/IGRpciA9PT0gYFhgID8gcHJlc3NLZXlzKFtgV2AsIGBBYF0pIDogcHJlc3NLZXlzKFtgV2AsIGBEYF0pIDogZGlyID09PSBgWGAgPyBwcmVzc0tleXMoW2BTYCwgYERgXSkgOiBwcmVzc0tleXMoW2BTYCwgYEFgXSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgNDU6CiAgICAgICAgICAgIHBuID09PSBgUGAgPyBkaXIgPT09IGBYYCA/IHByZXNzS2V5cyhbYFNgLCBgQWBdKSA6IHByZXNzS2V5cyhbYFdgLCBgQWBdKSA6IGRpciA9PT0gYFhgID8gcHJlc3NLZXlzKFtgV2AsIGBEYF0pIDogcHJlc3NLZXlzKFtgU2AsIGBEYF0pOwogICAgICAgICAgICBicmVhazsKICAgIH0KfQoKY29uc3QgTWluZWNyYWZ0ID0gQ2xpZW50LmdldE1pbmVjcmFmdCgpOwpsZXQgd29ya2luZyA9IGZhbHNlOwpsZXQgbG9va1ZlbG9jaXR5ID0gNzUKCmxldCBsb29rQXRCbG9jayA9ICh2ZWN0b3IpID0+IHsKICAgIGlmICgoTWluZWNyYWZ0LmZ1bmNfNzE0MTBfeCgpKS5maWVsZF83MTQ2Ml9yID09IG51bGwgfHwgKE1pbmVjcmFmdC5mdW5jXzcxNDEwX3goKSkuZmllbGRfNzE0NjJfciBpbnN0YW5jZW9mIG5ldC5taW5lY3JhZnQuY2xpZW50Lmd1aS5HdWlJbmdhbWVNZW51IHx8IChNaW5lY3JhZnQuZnVuY183MTQxMF94KCkpLmZpZWxkXzcxNDYyX3IgaW5zdGFuY2VvZiBuZXQubWluZWNyYWZ0LmNsaWVudC5ndWkuR3VpQ2hhdCkgewogICAgICAgIGlmICghd29ya2luZykgewogICAgICAgICAgICBuZXcgVGhyZWFkKCgpID0+IHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgd29ya2luZyA9IHRydWUKICAgICAgICAgICAgICAgICAgICBsZXQgZXllcyA9IFBsYXllci5nZXRQbGF5ZXIoKS5mdW5jXzE3NDgyNF9lKDEpCiAgICAgICAgICAgICAgICAgICAgbGV0IGRpZmZYID0gdmVjdG9yLmZpZWxkXzcyNDUwX2EgLSBleWVzLmZpZWxkXzcyNDUwX2EKICAgICAgICAgICAgICAgICAgICBsZXQgZGlmZlkgPSB2ZWN0b3IuZmllbGRfNzI0NDhfYiAtIGV5ZXMuZmllbGRfNzI0NDhfYgogICAgICAgICAgICAgICAgICAgIGxldCBkaWZmWiA9IHZlY3Rvci5maWVsZF83MjQ0OV9jIC0gZXllcy5maWVsZF83MjQ0OV9jCiAgICAgICAgICAgICAgICAgICAgbGV0IGRpc3QgPSBNYXRoLnNxcnQoZGlmZlggKiBkaWZmWCArIGRpZmZaICogZGlmZlopCiAgICAgICAgICAgICAgICAgICAgbGV0IHBpdGNoID0gLU1hdGguYXRhbjIoZGlzdCwgZGlmZlkpCiAgICAgICAgICAgICAgICAgICAgbGV0IHlhdyA9IE1hdGguYXRhbjIoZGlmZlosIGRpZmZYKQogICAgICAgICAgICAgICAgICAgIHBpdGNoID0gdG8xODAoKChwaXRjaCAqIDE4MC4wKSAvIE1hdGguUEkgKyA5MC4wKSAqIC0gMS4wIC0gUGxheWVyLmdldFBsYXllcigpLmZpZWxkXzcwMTI1X0EpCiAgICAgICAgICAgICAgICAgICAgeWF3ID0gdG8xODAoKHlhdyAqIDE4MC4wKSAvIE1hdGguUEkgLSA5MC4wIC0gUGxheWVyLmdldFBsYXllcigpLmZpZWxkXzcwMTc3X3opCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxvb2tWZWxvY2l0eTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIFBsYXllci5nZXRQbGF5ZXIoKS5maWVsZF83MDE3N196ICs9IHlhdyAvIGxvb2tWZWxvY2l0eQogICAgICAgICAgICAgICAgICAgICAgICBQbGF5ZXIuZ2V0UGxheWVyKCkuZmllbGRfNzAxMjVfQSArPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIFRocmVhZC5zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB3b3JraW5nID0gZmFsc2UKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0pLnN0YXJ0KCkKICAgICAgICB9CiAgICB9IAp9CgpmdW5jdGlvbiB0bzE4MChhbmdsZSkgewogICAgYW5nbGUgJT0gMzYwLjAKICAgIHdoaWxlIChhbmdsZSA+PSAxODAuMCkKICAgICAgYW5nbGUgLT0gMzYwLjAKICAgIHdoaWxlIChhbmdsZSA8IC0xODAuMCkKICAgICAgYW5nbGUgKz0gMzYwLjAKICAgIHJldHVybiBhbmdsZQp9Cgpjb25zdCBkaXN0Rm9ybXVsYSA9ICh4MSwgeTEsIHoxLCB4MiwgeTIsIHoyKSA9PiB7CiAgICByZXR1cm4gTWF0aC5zcXJ0KCh4MiAtIHgxKSAqKiAyICsgKHkyIC0geTEpICoqIDIgKyAoejIgLSB6MSkgKiogMik7Cn0KCmNvbnN0IGdldFNwZWVkID0gKCkgPT4gewogICAgY29uc3QgbGFzdFggPSBuZXcgRW50aXR5KFBsYXllci5nZXRQbGF5ZXIoKSkuZ2V0TGFzdFgoKTsKICAgIGNvbnN0IGxhc3RZID0gbmV3IEVudGl0eShQbGF5ZXIuZ2V0UGxheWVyKCkpLmdldExhc3RZKCk7CiAgICBjb25zdCBsYXN0WiA9IG5ldyBFbnRpdHkoUGxheWVyLmdldFBsYXllcigpKS5nZXRMYXN0WigpOwoKICAgIGNvbnN0IGN1cnJlbnRYID0gUGxheWVyLmdldFgoKTsKICAgIGNvbnN0IGN1cnJlbnRZID0gUGxheWVyLmdldFkoKTsKICAgIGNvbnN0IGN1cnJlbnRaID0gUGxheWVyLmdldFooKTsKCiAgICByZXR1cm4gTWF0aC5yb3VuZCgyMCAqIGRpc3RGb3JtdWxhKGxhc3RYLCBsYXN0WSwgbGFzdFosIGN1cnJlbnRYLCBjdXJyZW50WSwgY3VycmVudFopICogMTApIC8gMTA7Cn0KCmxldCBjbG9zaW5nID0gZmFsc2U7CgpmdW5jdGlvbiBnZXRDaGFyZ2VzKGxhc3RHdWlPcGVuZWQpIHsKICAgIGNvbnN0IGludiA9IGdldExvd2VyQ29udGFpbmVyKGxhc3RHdWlPcGVuZWQpOwogICAgbGV0IGR1c3QgPSBuZXcgQXJyYXkoNTQpLmZpbGwoZmFsc2UpOwogICAgbGV0IGRpcnQgPSBuZXcgQXJyYXkoNTQpLmZpbGwoZmFsc2UpOwogICAgbGV0IHRyZWEgPSBuZXcgQXJyYXkoNTQpLmZpbGwoZmFsc2UpOwogICAgbGV0IGRjID0gMDsKICAgIGxldCBjaGFyZ2VzID0gMDsKCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1NDsgaSsrKSB7CiAgICAgICAgICBsZXQgaXRlbSA9IGludi5mdW5jXzcwMzAxX2EoaSk7CiAgICAgICAgICBpZiAoaXRlbSA9PT0gbnVsbCkgY29udGludWU7CiAgICAgICAgICBpZiAoZ2V0SXRlbUlkKGl0ZW0pICE9PSAnbWluZWNyYWZ0OnN0YWluZWRfZ2xhc3NfcGFuZScpIGNvbnRpbnVlOwogICAgICAgICAgbGV0IGRtZyA9IGl0ZW0uZnVuY183Nzk2MF9qKCk7CiAgICAgICAgICBkdXN0W2ldID0gZG1nID09PSAwOwogICAgICAgICAgZGlydFtpXSA9IGRtZyAhPT0gMC8qICYmIGRtZyAhPT0gNSovOwogICAgICAgICAgdHJlYVtpXSA9IGRtZyA9PT0gNTsKICAgICAgICAgIGlmIChkdXN0W2ldKSB7CiAgICAgICAgICAgIGQgPSBpdGVtOwogICAgICAgICAgICBkYysrOwogICAgICAgICAgfSBlbHNlIGlmIChkaXJ0W2ldICYmIGNoYXJnZXMgPT09IC0xKSB7CiAgICAgICAgICAgIGNvbnN0IHRhZyA9IGl0ZW0uZnVuY183Nzk3OF9wKCkuZnVuY183NDc3NV9sKCdkaXNwbGF5Jyk7CiAgICAgICAgICAgIGNvbnN0IGxvcmUgPSB0YWcuZnVuY18xNTAyOTVfYygnTG9yZScsIDgpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxvcmUuZnVuY183NDc0NV9jKCk7IGkrKykgewogICAgICAgICAgICAgIGxldCBtID0gbG9yZS5mdW5jXzE1MDMwN19mKGkpLm1hdGNoKC9ewqc3Q2hpc2VsIENoYXJnZXMgUmVtYWluaW5nOiDCpy4oXGQrKSQvKTsKICAgICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgICAgY2hhcmdlcyA9ICttWzFdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICB9CiAgICBpZiAoY2hhcmdlcyA9PT0gMCkgewogICAgICAgIGlmKGNsb3NpbmcpIHJldHVybjsKICAgICAgICBjbG9zaW5nID0gdHJ1ZTsKICAgICAgICBDbGllbnQuc2NoZWR1bGVUYXNrKHNsZWVwUGluZy81MCwgKCkgPT4gQ2xpZW50LmN1cnJlbnRHdWkuY2xvc2UoKSk7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IHJpZ2h0Q2xpY2tNZXRob2QgPSBDbGllbnQuZ2V0TWluZWNyYWZ0KCkuZ2V0Q2xhc3MoKS5nZXREZWNsYXJlZE1ldGhvZChgZnVuY18xNDcxMjFfYWdgLCBudWxsKQogICAgICAgICAgICByaWdodENsaWNrTWV0aG9kLnNldEFjY2Vzc2libGUodHJ1ZSk7CiAgICAgICAgICAgIHJpZ2h0Q2xpY2tNZXRob2QuaW52b2tlKENsaWVudC5nZXRNaW5lY3JhZnQoKSwgbnVsbCk7CiAgICAgICAgCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgc3RhcnQuc3RhcnQoKQogICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY2xvc2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSwgNTApCiAgICAgICAgICAgIH0sIHNsZWVwUGluZyo0KyhNYXRoLnJhbmRvbSgpKjEwKSk7CiAgICAgICAgfSwgc2xlZXBQaW5nKjQrKE1hdGgucmFuZG9tKCkqMTApKTsKICAgICAgICByZXR1cm47CiAgICB9Cn0KbGV0IGxvb2thYmxlID0gZmFsc2U7CgpmdW5jdGlvbiBzdGFydFBhdGgoKSB7CiAgICBzdGFydC5zdGFydCgpIAp9Cgpjb25zdCB3YWxrT24gPSAocG9pbnRzT2ZQYXRoKSA9PiB7CiAgICBjb25zdCBjdXJyWCA9IE1hdGgucm91bmQoUGxheWVyLmdldFgoKSAqIDEwKSAvIDEwOwogICAgY29uc3QgY3VyclkgPSBNYXRoLnJvdW5kKFBsYXllci5nZXRZKCkgKiAxMCkgLyAxMDsKICAgIGNvbnN0IGN1cnJaID0gTWF0aC5yb3VuZChQbGF5ZXIuZ2V0WigpICogMTApIC8gMTA7CgogICAgbGV0IHByZXZpb3VzID0gMTA7CiAgICBsZXQgY2xvc2VzdCA9IG51bGw7CgogICAgbGV0IG5leHRQb2ludCA9IG51bGw7CiAgICBsZXQgbmV4dE5leHRQb2ludCA9IG51bGw7CgogICAgcG9pbnRzT2ZQYXRoLmZvckVhY2gocG9pbnQgPT4gewogICAgICAgIGxldCBjdXJyZW50RGlzdCA9IGNhbGN1bGF0ZURpc3RhbmNlKGN1cnJYLCBjdXJyWSwgY3VyclosIHBvaW50LngsIHBvaW50LnksIHBvaW50LnopOwogICAgICAgIGlmIChjdXJyZW50RGlzdCA8PSBwcmV2aW91cykgewogICAgICAgICAgICBwcmV2aW91cyA9IGN1cnJlbnREaXN0OwogICAgICAgICAgICBjbG9zZXN0ID0gcG9pbnQ7CiAgICAgICAgICAgIGlmKHBvaW50c09mUGF0aC5pbmRleE9mKHBvaW50KSAhPT0gcG9pbnRzT2ZQYXRoLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgIG5leHRQb2ludCA9IHBvaW50c09mUGF0aFtwb2ludHNPZlBhdGguaW5kZXhPZihwb2ludCkgKyAxXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYocG9pbnRzT2ZQYXRoLmluZGV4T2YocG9pbnQpICE9PSBwb2ludHNPZlBhdGgubGVuZ3RoIC0gMikgewogICAgICAgICAgICAgICAgbmV4dE5leHRQb2ludCA9IHBvaW50c09mUGF0aFtwb2ludHNPZlBhdGguaW5kZXhPZihwb2ludCkgKyAyXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pOwoKICAgIGlmKGNsb3Nlc3QgIT09IG51bGwgJiYgbmV4dFBvaW50ICE9PSBudWxsKSB7CiAgICAgICAgLy9zdG9wQWxsTW92ZW1lbnQoKTsKICAgICAgICBpZihjbG9zZXN0ID09PSBwb2ludHNPZlBhdGhbcG9pbnRzT2ZQYXRoLmxlbmd0aCAtIDFdKSByZXR1cm4gdHJ1ZTsKICAgICAgICBjb25zdCBjdXJyWWF3ID0gTWF0aC5mbG9vcihQbGF5ZXIuZ2V0WWF3KCkpOwogICAgICAgIAogICAgICAgIGlmKCFyb3Rtb2RlKSB7CiAgICAgICAgICAgIGlmKGN1cnJYICE9PSBuZXh0UG9pbnQueCAmJiBjdXJyWCA8IG5leHRQb2ludC54KSBnZXRCaW5kKGBYYCwgYFBgLCBjdXJyWWF3KTsKICAgICAgICAgICAgaWYoY3VyclggIT09IG5leHRQb2ludC54ICYmIGN1cnJYID4gbmV4dFBvaW50LngpIGdldEJpbmQoYFhgLCBgTmAsIGN1cnJZYXcpOwogICAgICAgICAgICBpZihjdXJyWiAhPT0gbmV4dFBvaW50LnogJiYgY3VyclogPCBuZXh0UG9pbnQueikgZ2V0QmluZChgWmAsIGBQYCwgY3Vycllhdyk7CiAgICAgICAgICAgIGlmKGN1cnJaICE9PSBuZXh0UG9pbnQueiAmJiBjdXJyWiA+IG5leHRQb2ludC56KSBnZXRCaW5kKGBaYCwgYE5gLCBjdXJyWWF3KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZihsb29rYWJsZSkgcmV0dXJuOwogICAgICAgICAgICBsb29rYWJsZSA9IHRydWU7CiAgICAgICAgICAgIHN0YXJ0ZWQgPSB0cnVlOwogICAgICAgICAgICBmb3J3YXJkQmluZC5zZXRTdGF0ZSh0cnVlKTsKICAgICAgICAgICAgLy9zbmVha0JpbmQuc2V0U3RhdGUodHJ1ZSkKICAgICAgICAgICAgbG9va0F0QmxvY2soCiAgICAgICAgICAgICAgICBuZXcgbmV0Lm1pbmVjcmFmdC51dGlsLlZlYzMoCiAgICAgICAgICAgICAgICAgICAgbmV4dE5leHRQb2ludC54LAogICAgICAgICAgICAgICAgICAgIG5leHROZXh0UG9pbnQueSwKICAgICAgICAgICAgICAgICAgICBuZXh0TmV4dFBvaW50LnoKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgKTsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBsb29rYWJsZSA9IGZhbHNlCiAgICAgICAgICAgIH0sIDc1KTsKICAgICAgICB9CgogICAgICAgIGlmKGNsb3Nlc3QueSArIDEgPT09IG5leHRQb2ludC55IHx8IE1hdGgucm91bmQoUGxheWVyLmdldFkoKSkgKyAxLjUgPT09IG5leHRQb2ludC55KSBqdW1wQmluZC5zZXRTdGF0ZSh0cnVlKTsKICAgICAgICBlbHNlIGp1bXBCaW5kLnNldFN0YXRlKGZhbHNlKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0KCmNvbnN0IGNhbGN1bGF0ZURpc3RhbmNlID0gKHgxLCB5MSwgejEsIHgyLCB5MiwgejIpID0+IHsKICAgIHJldHVybiBNYXRoLnNxcnQoKHgyIC0geDEpICoqIDIgKyAoeTIgLSB5MSkgKiogMiArICh6MiAtIHoxKSAqKiAyKTsKfQoKbGV0IHByZWZpeCA9IGDCp2zCpzRbwqdswqdjQnJlbm5lbnNNb2R1bGXCp2zCpzRdIMKncsKnZmAKbGV0IHNsZWVwUGluZyA9IDMwMDsKCmNsYXNzIHN0YXRlIHsKICAgIGNvbnN0cnVjdG9yKHN0YXRlKSB7CiAgICAgICAgdGhpcy5zdGF0ZSA9IHN0YXRlCiAgICB9CgogICAgZ2V0U3RhdGUoKSB7IHJldHVybiB0aGlzLnN0YXRlIH0KICAgIHNldFN0YXRlKG5ld1N0YXRlKSB7IHRoaXMuc3RhdGUgPSBuZXdTdGF0ZSB9CgogICAgc3RhdGljIE9QRU5JTkcgPSBgT1BFTklOR2AKICAgIHN0YXRpYyBNQUNST0lORyA9IGBNQUNST0lOR2AKICAgIHN0YXRpYyBSRVNUQVJUSU5HID0gYFJFU1RBUlRJTkdgCiAgICBzdGF0aWMgRElTQUJMRUQgPSBgRElTQUJMRURgCiAgICBzdGF0aWMgQlVZSU5HID0gYEJVWUlOR2AKICAgIHN0YXRpYyBGT1VORCA9IGBGT1VORGAKICAgIHN0YXRpYyBOT1RfRk9VTkQgPSBgTk9UX0ZPVU5EYAp9CgpsZXQgU3RhdGUgPSBuZXcgc3RhdGUoc3RhdGUuRElTQUJMRUQpCgpjb25zdCBjbGljayA9IChzbG90LCBzaGlmdCwgdHlwZSkgPT4gewogICAgaWYoIUNsaWVudC5jdXJyZW50R3VpKSByZXR1cm47CiAgICBpZighZ29pbmcpIHJldHVybiBmYWxzZTsKICAgIGNvbnN0IGNvbnRhaW5lciA9IFBsYXllci5nZXRDb250YWluZXIoKTsKICAgIGNvbnRhaW5lci5jbGljayhzbG90LCBzaGlmdCwgdHlwZSk7IAp9CgpsZXQgaW52YWxpZENsaWNrcyA9IDA7CgpsZXQgY2xpY2tlZFNsb3Q1MyA9IGZhbHNlCgpjb25zdCBjbGljazIgPSAoc2xvdCwgc2hpZnQsIHR5cGUpID0+IHsKICAgIGlmKCFDbGllbnQuY3VycmVudEd1aSkgcmV0dXJuOwogICAgaWYoIWdvaW5nKSByZXR1cm4gZmFsc2U7CiAgICBpZihzbG90ID09IDUzICYmICFjbGlja2VkU2xvdDUzKSBjbGlja2VkU2xvdDUzID0gdHJ1ZTsKICAgIGlmKHNsb3QgPT0gNTMgJiYgY2xpY2tlZFNsb3Q1MykgewogICAgICAgIG5vdFNpZ21hID0gdHJ1ZTsKICAgICAgICBmb3VuZC5zdG9wKCk7CiAgICAgICAgbm90Rm91bmQuc3RhcnQoKTsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgY2xpY2tlZFNsb3Q1MyA9IGZhbHNlOwogICAgICAgIH0sIHNsZWVwUGluZyozKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICBjb25zdCBjb250YWluZXIgPSBQbGF5ZXIuZ2V0Q29udGFpbmVyKCk7CiAgICBjb250YWluZXIuY2xpY2soc2xvdCwgc2hpZnQsIHR5cGUpOwogICAgaW52YWxpZENsaWNrcysrIAp9Cgpjb25zdCBzdGFydCA9IG5ldyBUaHJlYWQoKCkgPT4gewogICAgaWYoCiAgICAgICAgUGxheWVyLmdldENvbnRhaW5lcigpID09IHVuZGVmaW5lZCB8fCAKICAgICAgICAhUGxheWVyPy5nZXRDb250YWluZXIoKT8uZ2V0TmFtZSgpPy50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKGBmb3NzaWxgKSB8fAogICAgICAgICFQbGF5ZXI/LmdldENvbnRhaW5lcigpPy5nZXRJdGVtcygpPy5maW5kSW5kZXgoaSA9PiBpPy5nZXROYW1lKCk/LnRvTG93ZXJDYXNlKCk/LmluY2x1ZGVzKGBzdGFydCBleGNhdmF0b3JgKSkKICAgICkgewogICAgICAgIGlmKCFlbmFibGVkKSByZXR1cm47CiAgICAgICAgZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIHN0YXJ0LnN0b3AoKQogICAgICAgIENoYXRMaWIuY2hhdChwcmVmaXggKyBgT3BlbmluZyBHdWkuYCk7CiAgICAgICAgbG9va0F0QmxvY2soICAgICAgICAgICAgICAgIAogICAgICAgICAgICBuZXcgbmV0Lm1pbmVjcmFmdC51dGlsLlZlYzMoCiAgICAgICAgICAgICAgICAxOSwKICAgICAgICAgICAgICAgIDEyMCsxLjUsCiAgICAgICAgICAgICAgICAyMjcKICAgICAgICAgICAgKQogICAgICAgICkKICAgICAgICByZXR1cm4gc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGxlZnRDbGlja01ldGhvZCA9IENsaWVudC5nZXRNaW5lY3JhZnQoKS5nZXRDbGFzcygpLmdldERlY2xhcmVkTWV0aG9kKGBmdW5jXzE0NzExNl9hZmAsIG51bGwpCiAgICAgICAgICAgIGxlZnRDbGlja01ldGhvZC5zZXRBY2Nlc3NpYmxlKHRydWUpOwogICAgICAgICAgICBsZWZ0Q2xpY2tNZXRob2QuaW52b2tlKENsaWVudC5nZXRNaW5lY3JhZnQoKSwgbnVsbCkKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBzdGFydC5zdGFydCgpCiAgICAgICAgICAgIH0sIDE1MDApOwogICAgICAgIH0sIDUwMCk7CiAgICB9CiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBsZXQgc2NyYXBJbmRleDsKICAgICAgICBsZXQgY2hpc2VsSW5kZXg7CiAgICAKICAgICAgICBmb3IgKGxldCBpID0gUGxheWVyLmdldENvbnRhaW5lcigpLmdldEl0ZW1zKCkubGVuZ3RoIC0gMTsgaSA+IFBsYXllci5nZXRDb250YWluZXIoKS5nZXRJdGVtcygpLmxlbmd0aCAtIFBsYXllci5nZXRJbnZlbnRvcnkoKS5nZXRJdGVtcygpLmxlbmd0aDsgaS0tKSB7CiAgICAgICAgICAgIGxldCBpdGVtID0gUGxheWVyLmdldENvbnRhaW5lcigpLmdldFN0YWNrSW5TbG90KGkpOwogICAgCiAgICAgICAgICAgIGlmIChpdGVtICE9PSBudWxsICYmIGl0ZW0/LmdldE5hbWUoKT8udG9Mb3dlckNhc2UoKT8uaW5jbHVkZXMoYHN1c3BpY2lvdXMgc2NyYXBgKSkgewogICAgICAgICAgICAgICAgc2NyYXBJbmRleCA9IGk7CiAgICAgICAgICAgIH0KICAgIAogICAgICAgICAgICBpZiAoaXRlbSAhPT0gbnVsbCAmJiBpdGVtPy5nZXROYW1lKCk/LnRvTG93ZXJDYXNlKCk/LmluY2x1ZGVzKGAgY2hpc2VsYCkpIHsKICAgICAgICAgICAgICAgIGNoaXNlbEluZGV4ID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIAogICAgICAgIGlmKGNoaXNlbEluZGV4ICE9PSAtMSAmJiAgIXNjcmFwSW5kZXggfHwgc2NyYXBJbmRleCA9PSAtMSkgewogICAgICAgICAgICBDaGF0TGliLmNoYXQocHJlZml4ICsgYFNjcmFwIE1pc3NpbmcsIEF0dGVtcHRpbmcgdG8gYnV5IGZyb20gYnouYCk7CiAgICAgICAgICAgIENsaWVudC5jdXJyZW50R3VpLmNsb3NlKCkKICAgICAgICAgICAgcmV0dXJuIHNldFRpbWVvdXQoKCkgPT4gYnpidXkuc3RhcnQoKSwgNTAwKTsKICAgICAgICB9CiAgICAgICAgaWYoIWNoaXNlbEluZGV4IHx8IGNoaXNlbEluZGV4ID09IC0xIHx8ICFzY3JhcEluZGV4IHx8IHNjcmFwSW5kZXggPT0gLTEpIHsKICAgICAgICAgICAgQ2hhdExpYi5jaGF0KHByZWZpeCArIGBTY3JhcCBvciBDaGlzZWwgTWlzc2luZy5gKTsKICAgICAgICAgICAgZ29pbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIAogICAgCiAgICAgICAgU3RhdGUuc2V0U3RhdGUoc3RhdGUuT1BFTklORykKICAgIAogICAgICAgIFRocmVhZC5zbGVlcChzbGVlcFBpbmcrKE1hdGgucmFuZG9tKCkqMTApKQogICAgICAgIGNsaWNrKHNjcmFwSW5kZXgsIHRydWUsIGBNSURETEVgKQogICAgICAgIFRocmVhZC5zbGVlcChzbGVlcFBpbmcrKE1hdGgucmFuZG9tKCkqMTApKQogICAgICAgIGNsaWNrKGNoaXNlbEluZGV4LCB0cnVlLCBgTUlERExFYCkKICAgICAgICBUaHJlYWQuc2xlZXAoc2xlZXBQaW5nKyhNYXRoLnJhbmRvbSgpKjEwKSkKICAgICAgICBjbGljaygzMSwgZmFsc2UsIGBNSURETEVgKQogICAgICAgIFRocmVhZC5zbGVlcChzbGVlcFBpbmcqMysoTWF0aC5yYW5kb20oKSoxMCkpCiAgICAKICAgICAgICBTdGF0ZS5zZXRTdGF0ZShzdGF0ZS5NQUNST0lORykKICAgICAgICBleGNhdmF0ZS5zdGFydCgpICAgICAgICAKICAgIH0sIHNsZWVwUGluZyoyKyhNYXRoLnJhbmRvbSgpKjEwKSk7Cn0pCgpjb25zdCB0ZXN0VGVzdCA9IFsKICAgIFs0LCAyXSwKICAgIFs1LCA0XSwKICAgIFszLCAzXSwKICAgIFs1LCAyXSwKICAgIFszLCAxXSwKICAgIFs3LCAzXSwKICAgIFsxLCAyXSwKICAgIFszLCA0XQpdCgpjb25zdCBzbG90cyA9IFsKICAgIDIyLAogICAgNDEsCiAgICAzMCwKICAgIDIzLAogICAgMTIsCiAgICAzNCwKICAgIDE5LAogICAgMzkKXTsKCnJlZ2lzdGVyKGBzdGVwYCwoKT0+ewogIGlmKCFDbGllbnQuaXNJbkd1aSgpKSByZXR1cm47CiAgc3RvcEFsbE1vdmVtZW50KCkKfSkKCmNvbnN0IGJ6YnV5ID0gbmV3IFRocmVhZCgoKSA9PiB7CiAgICBDaGF0TGliLmNvbW1hbmQoYGJ6IHN1c3BpY2lvdXMgc2NyYXBgKQogICAgVGhyZWFkLnNsZWVwKHNsZWVwUGluZysoTWF0aC5yYW5kb20oKSoxMCkpCiAgICBpZighQ2xpZW50LmlzSW5HdWkoKSkgcmV0dXJuIENoYXRMaWIuY2hhdChwcmVmaXgrYEJaIE1lbnUgTm90IE9wZW5lZCBBZnRlciBSdW5uaW5nIENvbW1hbmQsIE5vIENvb2tpZUJ1ZmY/YCk7CiAgICBQbGF5ZXIuZ2V0Q29udGFpbmVyKCkuY2xpY2soMTEsIGZhbHNlLCBgTUlERExFYCkKICAgIFRocmVhZC5zbGVlcChzbGVlcFBpbmcrKE1hdGgucmFuZG9tKCkqMTApKQogICAgUGxheWVyLmdldENvbnRhaW5lcigpLmNsaWNrKDEwLCBmYWxzZSwgYE1JRERMRWApCiAgICBUaHJlYWQuc2xlZXAoc2xlZXBQaW5nKyhNYXRoLnJhbmRvbSgpKjEwKSkKICAgIFBsYXllci5nZXRDb250YWluZXIoKS5jbGljaygxMiwgZmFsc2UsIGBNSURETEVgKQogICAgVGhyZWFkLnNsZWVwKHNsZWVwUGluZysoTWF0aC5yYW5kb20oKSoxMCkpCiAgICBDbGllbnQuY3VycmVudEd1aS5jbG9zZSgpCiAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICBzdGFydC5zdGFydCgpCiAgICB9LCBzbGVlcFBpbmcqNSsoTWF0aC5yYW5kb20oKSoxMCkpOwp9KQoKY29uc3Qgc2xvdHNDbGlja2VkID0gW10KY29uc3QgY3VyckZvc3NpbCA9IFtdCgpjb25zdCBleGNhdmF0ZSA9IG5ldyBUaHJlYWQoKCkgPT4gewogICAgbGV0IGZvc3NpbEZvdW5kID0gZmFsc2U7CgogICAgc2xvdHMuZm9yRWFjaCgoc2xvdCwgaW5kZXgpID0+IHsKICAgICAgICBpZihTdGF0ZS5nZXRTdGF0ZSgpID09IHN0YXRlLkZPVU5EKSByZXR1cm47CgogICAgICAgIFRocmVhZC5zbGVlcChzbGVlcFBpbmcvNCsoTWF0aC5yYW5kb20oKSoxMCkpCiAgICAgICAgY2xpY2soc2xvdCwgZmFsc2UsIGBNSURETEVgKTsKICAgICAgICBUaHJlYWQuc2xlZXAoc2xlZXBQaW5nKyhNYXRoLnJhbmRvbSgpKjEwKSkKICAgICAgICBzbG90c0NsaWNrZWQucHVzaChbdGVzdFRlc3RbaW5kZXhdXSkKCiAgICAgICAgaWYgKAogICAgICAgICAgICBQbGF5ZXI/LmdldENvbnRhaW5lcigpPy5nZXRTdGFja0luU2xvdChzbG90KT8uZ2V0TmFtZSgpPy50b0xvd2VyQ2FzZSgpPy5pbmNsdWRlcyhgZm9zc2lsYCkgJiYgCiAgICAgICAgICAgICFQbGF5ZXI/LmdldENvbnRhaW5lcigpPy5nZXRTdGFja0luU2xvdChzbG90KT8uZ2V0TmFtZSgpPy50b0xvd2VyQ2FzZSgpPy5pbmNsdWRlcyhgZm9zc2lsIGR1c3RgKSAmJgogICAgICAgICAgICAhUGxheWVyPy5nZXRDb250YWluZXIoKT8uZ2V0U3RhY2tJblNsb3Qoc2xvdCk/LmdldE5hbWUoKT8udG9Mb3dlckNhc2UoKT8uaW5jbHVkZXMoYGZvc3NpbCB0aGUgZmlzaGApCiAgICAgICAgKSB7CiAgICAgICAgICAgIGN1cnJGb3NzaWwucHVzaChzbG90KQogICAgICAgICAgICBTdGF0ZS5zZXRTdGF0ZShzdGF0ZS5GT1VORCk7CiAgICAgICAgICAgIGZvc3NpbEZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgZm91bmQuc3RhcnQoKQogICAgICAgICAgICByZXR1cm47IAogICAgICAgIH0KCiAgICAgICAgaWYgKGluZGV4ID09PSBzbG90cy5sZW5ndGggLSAxICYmICFmb3NzaWxGb3VuZCkgewogICAgICAgICAgICBTdGF0ZS5zZXRTdGF0ZShzdGF0ZS5OT1RfRk9VTkQpOwogICAgICAgICAgICBub3RGb3VuZC5zdGFydCgpCiAgICAgICAgfQogICAgfSk7Cn0pOwpjb25zdCBmb3VuZCA9IG5ldyBUaHJlYWQoKCkgPT4gewogICAgaWYoIUNsaWVudC5jdXJyZW50R3VpKSByZXR1cm4gbGFzdEd1aU9wZW5lZCA9IGZhbHNlOwogICAgbm90Rm91bmQuc3RvcCgpCiAgICBleGNhdmF0ZS5zdG9wKCk7CiAgICBzdGFydC5zdG9wKCk7CgogICAgbGV0IHNsb3QgPSBnZXROZXh0U2xvdFRvQ2xpY2sobGFzdEd1aU9wZW5lZCkKCiAgICBpZihzbG90ID09IC0xKSByZXR1cm4gQ2hhdExpYi5jaGF0KCd0ZXN0Jyk7CiAgICBlbHNlIHsKICAgICAgICBpZihub3RTaWdtYSkgcmV0dXJuIENoYXRMaWIuY2hhdCgnbm90IHNpZ21hISEhISEnKQogICAgICAgIGNsaWNrMihzbG90LCBmYWxzZSwgJ0xFRlQnKQogICAgICAgIENsaWVudC5zY2hlZHVsZVRhc2soNCwgKCkgPT4gewogICAgICAgICAgICBmb3VuZC5zdGFydCgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfSkKICAgIH0KfSkKCmNvbnN0IG5vdEZvdW5kID0gbmV3IFRocmVhZCgoKSA9PiB7CiAgICBsZXQgc2xvdHMgPSBbXQoKICAgIFBsYXllci5nZXRDb250YWluZXIoKS5nZXRJdGVtcygpLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7CiAgICAgICAgaWYoIWl0ZW0pIHJldHVybjsKICAgICAgICBsZXQgZnMgPSBgYAogICAgICAgIGl0ZW0/LmdldExvcmUoKT8uZm9yRWFjaChzID0+IGZzICs9IHMpCiAgICAgICAgaWYoZnM/LmluY2x1ZGVzKGBoaWdobGlnaHRlZGApKSB7CiAgICAgICAgICAgIHJldHVybiBzbG90cy5wdXNoKGluZGV4KQogICAgICAgIH0KICAgIH0pCiAgICBQbGF5ZXIuZ2V0Q29udGFpbmVyKCkuZ2V0SXRlbXMoKS5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4gewogICAgICAgIGlmKCFpdGVtKSByZXR1cm47CiAgICAgICAgaWYoc2xvdHMuaW5jbHVkZXMoaW5kZXgpKSByZXR1cm47CiAgICAgICAgaWYoaXRlbT8uZ2V0TmFtZSgpPy50b0xvd2VyQ2FzZSgpPy5pbmNsdWRlcyhgZGlydGApICYmIHNsb3RzLmxlbmd0aCE9PTE1KSB7CiAgICAgICAgICAgIHNsb3RzLnB1c2goaW5kZXgpCiAgICAgICAgfSBlbHNlIHJldHVybjsKICAgIH0pCiAgICBzbG90cy5mb3JFYWNoKGluZGV4ID0+IHsKICAgICAgICAvL0NoYXRMaWIuY2hhdChwcmVmaXggKyBgQ2xpY2tpbmcgSW5kZXg6ICR7aW5kZXh9YCkKICAgICAgICBUaHJlYWQuc2xlZXAoNTApCiAgICAgICAgY2xpY2soaW5kZXgsIGZhbHNlLCBgTUlERExFYCk7CiAgICAgICAgVGhyZWFkLnNsZWVwKHNsZWVwUGluZysoTWF0aC5yYW5kb20oKSoxMCkpOwogICAgfSkKCiAgICBnZXRDaGFyZ2VzKGxhc3RHdWlPcGVuZWQpCn0pCgpsZXQgZ29pbmcgPSBmYWxzZTsKCmxldCBvbGRNb3VzZUhlbHBlciA9IGZhbHNlOwpsZXQgdW5ncmFiYmVkID0gZmFsc2U7CgpmdW5jdGlvbiB1bmdyYWIoKSB7CiAgICB1bmdyYWJiZWQgPSB0cnVlOwogICAgbGV0IG1jID0gQ2xpZW50LmdldE1pbmVjcmFmdCgpOwogICAgbWMuZmllbGRfNzE0NzRfeS5maWVsZF84Mjg4MV95ID0gZmFsc2UKICAgIGlmKCFvbGRNb3VzZUhlbHBlcikgb2xkTW91c2VIZWxwZXIgPSBtYy5maWVsZF83MTQxN19CCiAgICBvbGRNb3VzZUhlbHBlci5mdW5jXzc0MzczX2IoKQogICAgbWMuZmllbGRfNzE0MTVfRyA9IHRydWUKICAgIG1jLmZpZWxkXzcxNDE3X0IgPSBuZXcgSmF2YUFkYXB0ZXIobmV0Lm1pbmVjcmFmdC51dGlsLk1vdXNlSGVscGVyLCB7CiAgICAgICAgImZ1bmNfNzQzNzRfYyI6IGZ1bmN0aW9uKCkgewogICAgICAgIH0sCiAgICAgICAgImZ1bmNfNzQzNzJfYSI6IGZ1bmN0aW9uKCkgewogICAgICAgIH0sCiAgICAgICAgImZ1bmNfNzQzNzNfYiI6IGZ1bmN0aW9uKCkgewogICAgICAgIH0KICAgIH0pCn0KCmZ1bmN0aW9uIHJlZ3JhYigpIHsKICAgIGlmKCF1bmdyYWJiZWQpIHJldHVybjsKICAgIHVuZ3JhYmJlZCA9IGZhbHNlOwogICAgbGV0IG1jID0gQ2xpZW50LmdldE1pbmVjcmFmdCgpOwogICAgbWMuZmllbGRfNzE0MTdfQiA9IG9sZE1vdXNlSGVscGVyCiAgICBtYy5maWVsZF83MTQxN19CLmZ1bmNfNzQzNzJfYSgpCiAgICBvbGRNb3VzZUhlbHBlciA9IG51bGwKfQoKY29uc3Qga2V5ID0gbmV3IEtleUJpbmQoYEZvc3NpbCBNYWNyb2AsIEtleWJvYXJkLktFWV9OT05FLCBgQnJlbm5lbnNNb2R1bGUgLSBNYWNyb3NgKQpsZXQgZW5hYmxlZCA9IGZhbHNlOwoKcmVnaXN0ZXIoJ3N0ZXAnLCAoKSA9PiB7CiAgICBpZihDbGllbnQuaXNJbkNoYXQoKSkgcmV0dXJuOwogICAgLy9DaGF0TGliLmNoYXQoS2V5Ym9hcmQuaXNLZXlEb3duKGtleS5nZXRLZXlDb2RlKCkpKQogICAgaWYoa2V5LmlzUHJlc3NlZCgpKSB7CiAgICAgICAgaWYoZW5hYmxlZCkgcmV0dXJuOwogICAgICAgIGVuYWJsZWQgPSB0cnVlOwogICAgICAgIGlmKGdvaW5nKSBnb2luZz1mYWxzZTsgZWxzZSBnb2luZz10cnVlOwogICAgICAgIGlmKGdvaW5nKSB7CiAgICAgICAgICAgIENoYXRMaWIuY2hhdChwcmVmaXggKyBgU3RhcnRpbmcuLi5gKQogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHJpZ2h0Q2xpY2tNZXRob2QgPSBDbGllbnQuZ2V0TWluZWNyYWZ0KCkuZ2V0Q2xhc3MoKS5nZXREZWNsYXJlZE1ldGhvZChgZnVuY18xNDcxMjFfYWdgLCBudWxsKQogICAgICAgICAgICAgICAgcmlnaHRDbGlja01ldGhvZC5zZXRBY2Nlc3NpYmxlKHRydWUpOwogICAgICAgICAgICAgICAgcmlnaHRDbGlja01ldGhvZC5pbnZva2UoQ2xpZW50LmdldE1pbmVjcmFmdCgpLCBudWxsKTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvL3N0YXJ0LnN0YXJ0KCkKICAgICAgICAgICAgICAgICAgICBzdGFydC5zdGFydCgpCiAgICAgICAgICAgICAgICB9LCBzbGVlcFBpbmcqMysoTWF0aC5yYW5kb20oKSoxMCkpOwogICAgICAgICAgICB9LCBzbGVlcFBpbmcrKE1hdGgucmFuZG9tKCkqMTApKTsKICAgICAgICAgICAgCiAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgIENoYXRMaWIuY2hhdChwcmVmaXggKyBgU3RvcHBpbmcuLi5gKSAKCiAgICAgICAgICAgIHJlZ3JhYigpCiAgICAgICAgICAgIHN0YXJ0LnN0b3AoKTsKICAgICAgICAgICAgZXhjYXZhdGUuc3RvcCgpOwogICAgICAgICAgICBub3RGb3VuZC5zdG9wKCk7CgogICAgICAgICAgICBzdG9wQWxsTW92ZW1lbnQoKQogICAgICAgIH0KICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgZW5hYmxlZCA9IGZhbHNlOwogICAgICAgIH0sIDUwMCk7CiAgICB9Cn0pCgpyZWdpc3RlcihgdGlja2AsICgpID0+IHsKICAgIGlmKGdvaW5nKSB7CiAgICAgICAgaWYoU3RhdGUuZ2V0U3RhdGUoKSAhPT0gc3RhdGUuUkVTVEFSVElORykgcmV0dXJuOwogICAgICAgIFN0YXRlLnNldFN0YXRlKHN0YXRlLkRJU0FCTEVEKQogICAgICAgIENsaWVudC5jdXJyZW50R3VpLmNsb3NlKCkKICAgIH0KfSkKCnJlZ2lzdGVyKCdjb21tYW5kJywgKCkgPT4gewogICAgcmVncmFiKCkKfSkuc2V0TmFtZSgncmVncmFibW91c2UnKQoKbGV0IGluZnJhY3Rpb25zID0gMDsKCnJlZ2lzdGVyKCd0aWNrJywgKCkgPT4gewogICAgaWYoYXV0b1dhbGspIHsKICAgICAgICBsZXQgd2Fsa1Rhc2sgPSB3YWxrT24oY3VycmVudFVzZXJQYXRoKTsKICAgICAgICBpZihhdXRvV2FsayAmJiAhd2Fsa1Rhc2sgJiYgZ2V0U3BlZWQoKSA9PT0gMCkgewogICAgICAgICAgICBpbmZyYWN0aW9ucysrOwogICAgICAgICAgICBpZihpbmZyYWN0aW9ucyA+PSAxMDApIHsKICAgICAgICAgICAgICAgIGp1bXBCaW5kLnNldFN0YXRlKHRydWUpOwogICAgICAgICAgICAgICAgaWYoaW5mcmFjdGlvbnMgPj0gMTQwKSB7CiAgICAgICAgICAgICAgICAgICAgaW5mcmFjdGlvbnMgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmKGF1dG9XYWxrICYmIHdhbGtUYXNrKSB7CiAgICAgICAgICAgIGF1dG9XYWxrID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRVc2VyUGF0aCA9IFtdOwogICAgICAgICAgICBDaGF0TGliLnNpbXVsYXRlQ2hhdChgJHtwcmVmaXh9YXJyaXZlZC5gKTsKICAgICAgICAgICAgZW5hYmxlZCA9IHRydWU7CiAgICAgICAgICAgIHN0b3BBbGxNb3ZlbWVudCgpCiAgICAgICAgICAgIGxvb2tBdEJsb2NrKAogICAgICAgICAgICAgICAgbmV3IG5ldC5taW5lY3JhZnQudXRpbC5WZWMzKAogICAgICAgICAgICAgICAgICAgIDE5LAogICAgICAgICAgICAgICAgICAgIDEyMCsxLjUsCiAgICAgICAgICAgICAgICAgICAgMjI3CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICkKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBzdGFydC5zdGFydCgpIAogICAgICAgICAgICB9LCAxMDAwKTsKICAgICAgICB9CiAgICB9Cn0pOwoKcmVnaXN0ZXIoJ3JlbmRlcldvcmxkJywgKCkgPT4gewogICAgaWYoY3VycmVudFVzZXJQYXRoID09PSB1bmRlZmluZWQpIHJldHVybjsKICAgIGlmKGN1cnJlbnRVc2VyUGF0aC5sZW5ndGggPD0gMSkgcmV0dXJuOwogICAgCiAgICBjdXJyZW50VXNlclBhdGguZm9yRWFjaCgocG9pbnQsIGluZGV4KSA9PiB7CiAgICAgICAgaWYocG9pbnQgPT0gY3VycmVudFVzZXJQYXRoW2N1cnJlbnRVc2VyUGF0aC5sZW5ndGggLSAxXSkgewogICAgICAgICAgICBUZXNzZWxsYXRvci5kcmF3U3RyaW5nKGDCp2NGaW5hbCBQb2ludGAsIHBvaW50LngsIHBvaW50LnkgKyBQbGF5ZXIuYXNQbGF5ZXJNUCgpLmdldEV5ZUhlaWdodCgpLCBwb2ludC56LCBSZW5kZXJlci5XSElURSwgdHJ1ZSwgMC4wMiwgZmFsc2UpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIFJlbmRlckxpYi5kcmF3RXNwQm94KHBvaW50LngsIHBvaW50LnktMS41LCBwb2ludC56LCAxLCAxLCAxLCAwLDAsIDAuMjUsIHRydWUpOwogICAgICAgIH0KICAgIH0pOwp9KTs
